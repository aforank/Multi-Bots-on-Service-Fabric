namespace OneBank.Common
{
    using System;
    using System.IO;
    using System.IO.Compression;
    using System.Threading;
    using System.Threading.Tasks;
    using Microsoft.Bot.Builder.Dialogs;
    using Microsoft.Bot.Builder.Dialogs.Internals;
    using Microsoft.Bot.Connector;
    using Microsoft.ServiceFabric.Actors;
    using Microsoft.ServiceFabric.Actors.Client;
    using Newtonsoft.Json;
    using OneBank.BotStateActor.Interfaces;

    /// <summary>
    /// Defines the <see cref="ServiceFabricBotDataStore" />
    /// </summary>
    public class ServiceFabricBotDataStore : IBotDataStore<BotData>
    {
        /// <summary>
        /// Defines the serializationSettings
        /// </summary>
        private static readonly JsonSerializerSettings SerializationSettings = new JsonSerializerSettings()
        {
            Formatting = Formatting.None,
            NullValueHandling = NullValueHandling.Ignore
        };

        /// <summary>
        /// Defines the botName
        /// </summary>
        private readonly string botName;

        /// <summary>
        /// The semaphore slim
        /// </summary>
        private readonly SemaphoreSlim semaphoreSlim = new SemaphoreSlim(1, 1);

        /// <summary>
        /// The bot state actor
        /// </summary>
        private IBotStateActor botStateActor;

        /// <summary>
        /// The store cache
        /// </summary>
        private StoreCacheEntry storeCache;

        /// <summary>
        /// Initializes a new instance of the <see cref="ServiceFabricBotDataStore" /> class.
        /// </summary>
        /// <param name="actorProxyFactory">The actor proxy factory.</param>
        /// <param name="userProfileProvider">The <see cref="IUserProfileProvider" /></param>
        /// <param name="logger">The logger.</param>
        /// <param name="botName">The <see cref="string" /></param>
        public ServiceFabricBotDataStore(string botName)
        {
            this.botName = botName;
        }

        /// <summary>
        /// The FlushAsync
        /// </summary>
        /// <param name="key">The <see cref="IAddress"/></param>
        /// <param name="cancellationToken">The <see cref="CancellationToken"/></param>
        /// <returns>Async Task</returns>
        public async Task<bool> FlushAsync(IAddress key, CancellationToken cancellationToken)
        {
            var botStateActor = await this.GetActorInstance(key.UserId, key.ChannelId);

            if (this.storeCache != null)
            {
                BotStateContext botStateContext = new BotStateContext()
                {
                    BotId = key.BotId,
                    ChannelId = key.ChannelId,
                    ConversationId = key.ConversationId,
                    UserId = key.UserId,
                    ConversationData = new StateData() { ETag = this.storeCache.ConversationData.ETag, Data = Serialize(this.storeCache.ConversationData.Data) },
                    PrivateConversationData = new StateData() { ETag = this.storeCache.PrivateConversationData.ETag, Data = Serialize(this.storeCache.PrivateConversationData.Data) },
                    UserData = new StateData() { ETag = this.storeCache.UserData.ETag, Data = Serialize(this.storeCache.UserData.Data) },
                    TimeStamp = DateTime.UtcNow
                };

                this.storeCache = null;
                await botStateActor.SaveBotStateAsync(this.GetStateKey(key), botStateContext, cancellationToken);
                return true;
            }
            else
            {
                return false;
            }
        }

        /// <summary>
        /// The LoadAsync
        /// </summary>
        /// <param name="key">The <see cref="IAddress"/></param>
        /// <param name="botStoreType">The <see cref="BotStoreType"/></param>
        /// <param name="cancellationToken">The <see cref="CancellationToken"/></param>
        /// <returns>The <see cref="Task{BotData}"/></returns>
        public async Task<BotData> LoadAsync(IAddress key, BotStoreType botStoreType, CancellationToken cancellationToken)
        {
            await this.semaphoreSlim.WaitAsync();

            try
            {
                if (this.storeCache != null)
                {
                    return this.GetFromStoreCache(botStoreType);
                }
                else
                {
                    var botStateActor = await this.GetActorInstance(key.UserId, key.ChannelId);
                    var botStateContext = await botStateActor.GetBotStateAsync(this.GetStateKey(key), cancellationToken);

                    this.storeCache = new StoreCacheEntry();

                    if (botStateContext != null)
                    {
                        this.storeCache.ConversationData = new BotData(botStateContext.ConversationData.ETag, Deserialize(botStateContext.ConversationData.Data));
                        this.storeCache.PrivateConversationData = new BotData(botStateContext.PrivateConversationData.ETag, Deserialize(botStateContext.PrivateConversationData.Data));
                        this.storeCache.UserData = new BotData(botStateContext.UserData.ETag, Deserialize(botStateContext.UserData.Data));
                    }
                    else
                    {
                        this.storeCache.ConversationData = new BotData("*", null);
                        this.storeCache.PrivateConversationData = new BotData("*", null);
                        this.storeCache.UserData = new BotData("*", null);
                    }

                    return this.GetFromStoreCache(botStoreType);
                }
            }
            finally
            {
                this.semaphoreSlim.Release();
            }
        }

        /// <summary>
        /// The SaveAsync
        /// </summary>
        /// <param name="key">The <see cref="IAddress"/></param>
        /// <param name="botStoreType">The <see cref="BotStoreType"/></param>
        /// <param name="data">The <see cref="BotData"/></param>
        /// <param name="cancellationToken">The <see cref="CancellationToken"/></param>
        /// <returns>The <see cref="Task"/></returns>
        public async Task SaveAsync(IAddress key, BotStoreType botStoreType, BotData data, CancellationToken cancellationToken)
        {
            if (this.storeCache == null)
            {
                this.storeCache = new StoreCacheEntry();
            }

            switch (botStoreType)
            {
                case BotStoreType.BotConversationData:
                    this.storeCache.ConversationData = data;
                    break;
                case BotStoreType.BotPrivateConversationData:
                    this.storeCache.PrivateConversationData = data;
                    break;
                case BotStoreType.BotUserData:
                    this.storeCache.UserData = data;
                    break;
                default:
                    throw new ArgumentException("Unsupported bot store type!");
            }

            await Task.CompletedTask;
        }

        /// <summary>
        /// The Serialize
        /// </summary>
        /// <param name="data">The <see cref="object"/></param>
        /// <returns>Serialized data</returns>
        private static byte[] Serialize(object data)
        {
            using (var cmpStream = new MemoryStream())
            using (var stream = new GZipStream(cmpStream, CompressionMode.Compress))
            using (var streamWriter = new StreamWriter(stream))
            {
                var serializedJSon = JsonConvert.SerializeObject(data, SerializationSettings);
                streamWriter.Write(serializedJSon);
                streamWriter.Close();
                stream.Close();
                return cmpStream.ToArray();
            }
        }

        /// <summary>
        /// The Deserialize
        /// </summary>
        /// <param name="bytes">Serialized data</param>
        /// <returns>The <see cref="object"/></returns>
        private static object Deserialize(byte[] bytes)
        {
            using (var stream = new MemoryStream(bytes))
            using (var gz = new GZipStream(stream, CompressionMode.Decompress))
            using (var streamReader = new StreamReader(gz))
            {
                return JsonConvert.DeserializeObject(streamReader.ReadToEnd());
            }
        }

        /// <summary>
        /// The GetActorInstance
        /// </summary>
        /// <param name="userId">The <see cref="string"/>User ID</param>
        /// <param name="channelId">The <see cref="string"/>Channel ID</param>
        /// <returns>The <see cref="Task{IBotStateActor}"/></returns>
        private async Task<IBotStateActor> GetActorInstance(string userId, string channelId)
        {
            if (this.botStateActor == null)
            {
                this.botStateActor = ActorProxy.Create<IBotStateActor>(new ActorId($"{userId}-{channelId}"), new Uri("fabric:/OneBank.FabricApp/BotStateActorService"));
            }

            return this.botStateActor;
        }

        /// <summary>
        /// The GetStateKey
        /// </summary>
        /// <param name="key">The <see cref="IAddress" /></param>
        /// <returns>
        /// The <see cref="string" />
        /// </returns>
        private string GetStateKey(IAddress key)
        {
            return $"{this.botName}{key.ConversationId}";
        }

        /// <summary>
        /// Gets from current bot state context.
        /// </summary>
        /// <param name="botStoreType">Type of the bot store.</param>
        /// <returns>Bot data</returns>
        /// <exception cref="System.ArgumentException">Unsupported bot store type!</exception>
        private BotData GetFromStoreCache(BotStoreType botStoreType)
        {
            switch (botStoreType)
            {
                case BotStoreType.BotConversationData:
                    return this.storeCache.ConversationData;

                case BotStoreType.BotUserData:
                    return this.storeCache.UserData;

                case BotStoreType.BotPrivateConversationData:
                    return this.storeCache.PrivateConversationData;

                default:
                    throw new ArgumentException("Unsupported bot store type!");
            }
        }
    }

    public class StoreCacheEntry
    {
        /// <summary>
        /// Gets or sets the bot conversation data.
        /// </summary>
        public BotData ConversationData { get; set; }

        /// <summary>
        /// Gets or sets the bot private conversation data.
        /// </summary>
        public BotData PrivateConversationData { get; set; }

        /// <summary>
        /// Gets or sets the bot user data.
        /// </summary>
        public BotData UserData { get; set; }
    }
}